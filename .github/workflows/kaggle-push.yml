name: Kaggle Push & Submit

on:
  workflow_dispatch:
    inputs:
      notebook_dir:
        description: 'Notebook directory (e.g., deep-past)'
        required: true
        type: string

jobs:
  push-and-submit:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install kaggle CLI
        run: pip install kaggle

      - name: Extract metadata
        id: meta
        run: |
          KERNEL_SLUG=$(python3 -c "import json; print(json.load(open('${{ inputs.notebook_dir }}/kernel-metadata.json'))['id'])")
          COMP_SLUG=$(python3 -c "
          import json
          sources = json.load(open('${{ inputs.notebook_dir }}/kernel-metadata.json')).get('competition_sources', [])
          print(sources[0] if sources else '')
          ")
          echo "kernel_slug=$KERNEL_SLUG" >> "$GITHUB_OUTPUT"
          echo "comp_slug=$COMP_SLUG" >> "$GITHUB_OUTPUT"

      - name: Push notebook to Kaggle
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: kaggle kernels push -p "${{ inputs.notebook_dir }}"

      - name: Wait for kernel completion
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          SLUG="${{ steps.meta.outputs.kernel_slug }}"
          echo "Waiting for $SLUG to complete..."
          for i in $(seq 1 60); do
            sleep 30
            OUTPUT=$(kaggle kernels status "$SLUG" 2>&1)
            echo "  [$i/60] $OUTPUT"
            if echo "$OUTPUT" | grep -q "COMPLETE"; then
              echo "Kernel completed successfully."
              exit 0
            fi
            if echo "$OUTPUT" | grep -q "ERROR"; then
              echo "Kernel failed."
              exit 1
            fi
          done
          echo "Timeout after 30 minutes."
          exit 1

      - name: Submit notebook to competition
        if: steps.meta.outputs.comp_slug != ''
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          python3 -c "
          from kaggle.api.kaggle_api_extended import KaggleApi
          api = KaggleApi()
          api.authenticate()
          api.competition_submit_code(
              file_name='submission.csv',
              message='Auto-submit from GitHub Actions',
              competition='${{ steps.meta.outputs.comp_slug }}',
              kernel='${{ steps.meta.outputs.kernel_slug }}'
          )
          print('Submission complete.')
          "
